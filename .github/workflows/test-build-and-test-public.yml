name: Test Build and Test SBT - Public

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-build-and-test-public:
    name: Test Build and Test (Maven Central)
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # Checkout
      # ========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # ========================================
      # Create Test Project (BEFORE calling action)
      # ========================================
      - name: Create Test Project
        run: |
          echo "=== Creating Test Project ==="
          mkdir -p test-project/project
          mkdir -p test-project/src/main/scala
          
          # Create project/build.properties
          cat > test-project/project/build.properties << 'EOF'
          sbt.version=1.10.4
          EOF
          
          # Create project/plugins.sbt (with plugins for dist and jacoco)
          cat > test-project/project/plugins.sbt << 'EOF'
          // Plugin for 'dist' command
          addSbtPlugin("com.github.sbt" % "sbt-native-packager" % "1.9.16")
          
          // Plugin for 'jacocoAggregate' command
          addSbtPlugin("com.github.sbt" % "sbt-jacoco" % "3.4.0")
          EOF
          
          # Create build.sbt
          cat > test-project/build.sbt << 'EOF'
          name := "test-project"
          version := "0.1.0"
          scalaVersion := "3.3.1"
          
          // Enable JavaAppPackaging for 'dist' command
          enablePlugins(JavaAppPackaging)
          
          libraryDependencies ++= Seq(
            "org.scala-lang.modules" %% "scala-parser-combinators" % "2.3.0"
          )
          
          // Jacoco settings
          jacocoReportSettings := JacocoReportSettings(
            "Jacoco Coverage Report",
            None,
            JacocoThresholds(),
            Seq(JacocoReportFormats.ScalaHTML, JacocoReportFormats.XML),
            "utf-8"
          )
          EOF
          
          # Create a simple Scala file
          cat > test-project/src/main/scala/Hello.scala << 'EOF'
          object Hello {
            def main(args: Array[String]): Unit = {
              println("Hello from test!")
            }
            
            def greet(name: String): String = {
              s"Hello, $name!"
            }
          }
          EOF
          
          echo "✓ Test project created with plugins (sbt-native-packager, sbt-jacoco)"
      
      # ========================================
      # Test Action: Build and Test
      # ========================================
      - name: Build and Test SBT Project (Public)
        id: build-test
        uses: ./.github/actions/build-and-test-sbt
        with:
          # Setup params (Maven Central by default)
          sbt-version: '1.10.4'
          scala-version: '3.3.1'
          java-version: '21'
          # No artifactory-host = Maven Central
          enable-cache: true
          
          # Build params
          sbt-commands: 'clean compile jacocoAggregate dist'
          working-directory: './test-project'
          
          # Artifact params (Upload .zip like production)
          upload-artifacts: true
          artifact-name-prefix: 'test-public'
          #artifact-path: './test-project/target/universal/*.zip'
          artifact-retention-days: 1
          artifact-if-no-files-found: 'warn'
      
      # ========================================
      # Verify Outputs
      # ========================================
      - name: Verify Build Outputs
        run: |
          echo "========================================="
          echo "Verifying Build Outputs"
          echo "========================================="
          
          # Check artifact name
          if [ -z "${{ steps.build-test.outputs.action-artifact-name }}" ]; then
            echo "❌ ERROR: action-artifact-name is empty"
            exit 1
          else
            echo "✅ Artifact Name: ${{ steps.build-test.outputs.action-artifact-name }}"
          fi
          
          # Check build status
          if [ "${{ steps.build-test.outputs.build-status }}" != "success" ]; then
            echo "❌ ERROR: Build status is not success"
            exit 1
          else
            echo "✅ Build Status: ${{ steps.build-test.outputs.build-status }}"
          fi
          
          # Check artifact uploaded
          if [ "${{ steps.build-test.outputs.artifact-uploaded }}" != "true" ]; then
            echo "❌ ERROR: Artifact not uploaded"
            exit 1
          else
            echo "✅ Artifact Uploaded: ${{ steps.build-test.outputs.artifact-uploaded }}"
          fi
          
          # Check SBT version
          if [ -z "${{ steps.build-test.outputs.sbt-version }}" ]; then
            echo "❌ ERROR: sbt-version is empty"
            exit 1
          else
            echo "✅ SBT Version: ${{ steps.build-test.outputs.sbt-version }}"
          fi
          
          echo "✅ Cache Hit: ${{ steps.build-test.outputs.cache-hit }}"
          
          echo ""
          echo "========================================="
          echo "✅ All Outputs Verified Successfully"
          echo "========================================="
      
      # ========================================
      # Verify Build Files
      # ========================================
      - name: Verify Build Files
        run: |
          echo "========================================="
          echo "Verifying Build Files"
          echo "========================================="
          
          cd test-project
          
          # Check if compiled classes exist
          if [ -d "target/scala-3.3.1/classes" ]; then
            echo "✅ Compiled classes found"
            ls -la target/scala-3.3.1/classes/ | head -10
          else
            echo "❌ ERROR: Compiled classes not found"
            exit 1
          fi
          
          echo ""
          
          # Check if Jacoco reports exist
          if [ -d "target/scala-3.3.1/jacoco" ]; then
            echo "✅ Jacoco reports found"
            ls -la target/scala-3.3.1/jacoco/
          else
            echo "⚠️  WARNING: Jacoco reports not found (may not have tests)"
          fi
          
          echo ""
          
          # Check if dist artifact (ZIP) exists
          if ls target/universal/*.zip 1> /dev/null 2>&1; then
            echo "✅ Dist artifact found"
            ls -lh target/universal/*.zip
          else
            echo "❌ ERROR: Dist artifact (ZIP) not found"
            exit 1
          fi
          
          echo ""
          echo "========================================="
          echo "✅ Build Files Verified"
          echo "========================================="
      
      # ========================================
      # Test Artifact Download
      # ========================================
      - name: Download Artifact (Test)
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.build-test.outputs.action-artifact-name }}
          path: ./downloaded-artifacts
      
      - name: Verify Downloaded Artifact
        run: |
          echo "========================================="
          echo "Verifying Downloaded Artifact"
          echo "========================================="
          
          if [ -d "./downloaded-artifacts" ]; then
            echo "✅ Artifacts directory exists"
            
            echo ""
            echo "Downloaded files:"
            find ./downloaded-artifacts -type f
            
            FILE_COUNT=$(find ./downloaded-artifacts -type f | wc -l)
            echo ""
            echo "Total files: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "⚠️  WARNING: No files downloaded"
            else
              echo "✅ Files downloaded successfully"
            fi
          else
            echo "❌ ERROR: Artifacts directory not found"
            exit 1
          fi
          
          echo ""
          echo "========================================="
          echo "✅ Artifact Download Test Completed"
          echo "========================================="
      
      # ========================================
      # Summary
      # ========================================
      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "TEST SUMMARY - BUILD AND TEST (PUBLIC)"
          echo "========================================="
          echo ""
          echo "Action Tested: build-and-test-sbt"
          echo "Mode: Public (Maven Central)"
          echo "SBT Version: ${{ steps.build-test.outputs.sbt-version }}"
          echo "Build Status: ${{ steps.build-test.outputs.build-status }}"
          echo "Artifact Name: ${{ steps.build-test.outputs.action-artifact-name }}"
          echo "Artifact Uploaded: ${{ steps.build-test.outputs.artifact-uploaded }}"
          echo "Cache Hit: ${{ steps.build-test.outputs.cache-hit }}"
          echo ""
          echo "========================================="
          
          if [ "${{ steps.build-test.outputs.build-status }}" == "success" ]; then
            echo "✅✅✅ ALL TESTS PASSED ✅✅✅"
          else
            echo "❌❌❌ TESTS FAILED ❌❌❌"
            exit 1
          fi
          
          echo "========================================="
